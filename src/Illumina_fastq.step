# Define Variables
while read var val; do unset $var ; if [[ $val == "(["* ]]; then declare -A $var="`echo $val | sed 's/].\"/]=\"/g'`" ; else declare $var="$val" ; fi ; done < config/env.txt
. $BIN/check_previous_step

# load modules
module load DeltaMP/${VERSION[DELTAMP]}

# Library to analyse
read LIB_NAME FWD_SUF RVS_SUF <<<`sed -n ${ARRAY_TASK}'p' config/lib2.list`
FWD_LIB=${LIB_NAME}${FWD_SUF/.$RAW_EXT.*/}
RVS_LIB=${LIB_NAME}${RVS_SUF/.$RAW_EXT.*/}
cd libraries

# Primer clipping
if [ $CLIPPING == "yes" ]
then
	FWDDIS=`awk -v F=${#FWD} -v D=$PDIFFS 'BEGIN{printf "%.2g\n", D/F}'`
	RVSDIS=`awk -v R=${#RVS} -v D=$PDIFFS 'BEGIN{printf "%.2g\n", D/R}'`
	# cutadapt
	cutadapt -g $FWD -O ${#FWD} -e $FWDDIS --no-indels --trimmed-only -o fastq/$LIB_NAME.fwd.fastq --info-file=raw_stat/$FWD_LIB.cutadapt $FWD_LIB.fastq > fastq/log.cutadapt.$LIB_NAME.txt
	cutadapt -g $RVS -O ${#RVS} -e $RVSDIS --no-indels --trimmed-only -o fastq/$LIB_NAME.rvs.fastq --info-file=raw_stat/$RVS_LIB.cutadapt $RVS_LIB.fastq >> fastq/log.cutadapt.$LIB_NAME.txt
	# primer logo
	weblogo -c classic -s large -t "$LIB_NAME: primer $FWD_NAME" < <(awk 'BEGIN{FS="\t"} NF==11{print ">"$1"\n"$6}' raw_stat/$FWD_LIB.cutadapt) > raw_stat/weblogo.$LIB_NAME.forward.eps
	weblogo -c classic -s large -t "$LIB_NAME: primer $RVS_NAME" < <(awk 'BEGIN{FS="\t"} NF==11{print ">"$1"\n"$6}' raw_stat/$RVS_LIB.cutadapt) > raw_stat/weblogo.$LIB_NAME.reverse.eps
else
	ln -s $PWD/$FWD_LIB.fastq $PWD/fastq/$LIB_NAME.fwd.fastq
	ln -s $PWD/$RVS_LIB.fastq $PWD/fastq/$LIB_NAME.rvs.fastq
fi

# Convert to fasta + qual for raw reads stat
mothur "#set.dir(input=fastq, output=fasta);
	fastq.info(fastq=$FWD_LIB.fastq);
	fastq.info(fastq=$RVS_LIB.fastq)"
awk '$0!~"^>"{sum=0;for(i=1;i<=NF;i++){sum+=$i};print int(sum/NF)}' fasta/$FWD_LIB.qual > raw_stat/$LIB_NAME.fwd.meanqual
awk '$0!~"^>"{for(i=1;i<=NF;i++){sum[i]+=$i;nb[i]+=1}}END{for(i=1;sum[i];i++){print int(sum[i]/nb[i])}}' fasta/$FWD_LIB.qual > raw_stat/$LIB_NAME.fwd.meanposqual
awk '$0!~"^>"{sum=0;for(i=1;i<=NF;i++){sum+=$i};print int(sum/NF)}' fasta/$RVS_LIB.qual > raw_stat/$LIB_NAME.rvs.meanqual
awk '$0!~"^>"{for(i=1;i<=NF;i++){sum[i]+=$i;nb[i]+=1}}END{for(i=1;sum[i];i++){print int(sum[i]/nb[i])}}' fasta/$RVS_LIB.qual > raw_stat/$LIB_NAME.rvs.meanposqual

rm fasta/$FWD_LIB.fasta fasta/$FWD_LIB.qual fasta/$RVS_LIB.fasta fasta/$RVS_LIB.qual

# list files and directories
. $BIN/list_step_files.sh

echo END



